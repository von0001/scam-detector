<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="/static/img/favicon.svg" />
  <title>ScamDetector Admin Command</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #050815;
      --panel: #0b1020;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --accent: #38bdf8;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --warn: #f59e0b;
      --border: rgba(148, 163, 184, 0.16);
      --card: linear-gradient(145deg, rgba(10, 18, 36, 0.96), rgba(16, 24, 48, 0.9));
      --shadow: 0 20px 70px rgba(0, 0, 0, 0.55);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.12), transparent 45%),
        radial-gradient(circle at 80% 0%, rgba(34, 197, 94, 0.1), transparent 50%),
        linear-gradient(135deg, #020617, #050815 45%, #020617);
      display: flex;
    }

    .layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      width: 100%;
      min-height: 100vh;
    }

    .sidebar {
      background: rgba(7, 12, 26, 0.9);
      border-right: 1px solid var(--border);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      box-shadow: inset -1px 0 0 rgba(255, 255, 255, 0.04);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-badge {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 0, #22c55e, #38bdf8 60%, #0ea5e9 100%);
      display: grid;
      place-items: center;
      font-weight: 800;
      color: #050815;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.08);
    }

    .brand-text h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: -0.02em;
    }

    .brand-text p {
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav a {
      text-decoration: none;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: rgba(255, 255, 255, 0.02);
      display: flex;
      align-items: center;
      gap: 10px;
      transition: border-color 0.18s ease, background 0.18s ease;
      font-size: 14px;
    }

    .nav a:hover {
      border-color: rgba(56, 189, 248, 0.35);
      background: rgba(56, 189, 248, 0.06);
    }

    .sidebar .pill {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.02);
      color: var(--muted);
      font-size: 13px;
    }

    .sidebar .pill strong { color: var(--accent); }

    main {
      padding: 18px 20px 28px;
      overflow: auto;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .topbar .title {
      margin: 0;
      font-size: 22px;
      letter-spacing: -0.02em;
    }

    .topbar .subtitle {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .quick-search {
      flex: 1;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
    }

    .quick-search input {
      width: 220px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 14px;
    }

    .status-pill {
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid rgba(56, 189, 248, 0.35);
      background: rgba(56, 189, 248, 0.12);
      color: var(--text);
      font-weight: 700;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .grid {
      display: grid;
      gap: 14px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .card h3 {
      margin: 0 0 6px;
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .card .value {
      font-size: 24px;
      font-weight: 800;
    }

    .muted { color: var(--muted); }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--text);
      background: rgba(255, 255, 255, 0.02);
    }

    .tag.warn { border-color: rgba(245, 158, 11, 0.45); color: #fbbf24; }
    .tag.danger { border-color: rgba(239, 68, 68, 0.55); color: #fecaca; }

    .section {
      margin-top: 8px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      background: rgba(255, 255, 255, 0.03);
      box-shadow: var(--shadow);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .section-header h2 {
      margin: 0;
      font-size: 16px;
      letter-spacing: -0.01em;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(56, 189, 248, 0.12);
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    button:hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(56, 189, 248, 0.2); }
    button:active { transform: translateY(0); }

    .btn-danger { border-color: rgba(239, 68, 68, 0.6); background: rgba(239, 68, 68, 0.12); }
    .btn-ghost { background: rgba(255, 255, 255, 0.04); }

    .timeline {
      display: grid;
      gap: 10px;
      max-height: 320px;
      overflow: auto;
      padding-right: 4px;
    }

    .event {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      padding: 10px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .event .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      margin-top: 4px;
    }

    .event .body {
      flex: 1;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th,
    .table td {
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      font-size: 13px;
    }

    .controls-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .range {
      width: 100%;
    }

    .log-panel {
      background: rgba(7, 11, 24, 0.75);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      max-height: 220px;
      overflow: auto;
      color: #cbd5f5;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }

    .chart-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      box-shadow: var(--shadow);
    }

    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(56, 189, 248, 0.4);
      background: rgba(5, 8, 21, 0.95);
      color: var(--text);
      box-shadow: var(--shadow);
      min-width: 220px;
      display: none;
    }

    .badges-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .banner {
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(239, 68, 68, 0.12);
      border: 1px solid rgba(239, 68, 68, 0.35);
      color: #fecaca;
      font-weight: 700;
      margin-bottom: 10px;
      display: none;
    }

    .command-palette {
      position: fixed;
      inset: 0;
      background: rgba(5, 8, 21, 0.72);
      backdrop-filter: blur(6px);
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding-top: 80px;
      z-index: 50;
    }

    .command-panel {
      width: min(680px, 92vw);
      background: #0b1020;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .command-panel input {
      width: 100%;
      padding: 14px;
      background: rgba(255, 255, 255, 0.04);
      border: none;
      color: var(--text);
      font-size: 14px;
    }

    .command-list {
      max-height: 320px;
      overflow: auto;
    }

    .command-item {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .command-item:hover {
      background: rgba(56, 189, 248, 0.08);
    }

    .grid-two {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }

    .status-message {
      color: var(--accent);
      font-size: 13px;
      min-height: 16px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-badge">SD</div>
        <div class="brand-text">
          <h1>Admin Command</h1>
          <p>Threat Ops & Telemetry</p>
        </div>
      </div>
      <div class="nav">
        <a href="#overview">Dashboard</a>
        <a href="#intelligence">Detection Intelligence</a>
        <a href="#users">Users</a>
        <a href="#engine">Engine Control</a>
        <a href="#logs">Logs & Debug</a>
        <a href="#flags">Feature Flags</a>
        <a href="#feedback-intel">Feedback Intel</a>
        <a href="#analytics">Analytics</a>
        <a href="#settings">Settings</a>
      </div>
      <div class="pill">
        <strong>Single-operator mode.</strong><br />
        Everything routes here: scans, feedback, overrides, and feature flags.
      </div>
      <div class="pill">
        Encrypted session - We never store raw content.
      </div>
    </aside>

    <main>
      <div id="incident-banner" class="banner">Security Incident Under Review</div>
      <div class="topbar">
        <div>
          <h1 class="title">Command Center</h1>
          <p class="subtitle">Decide fast. Act fast. No guesswork.</p>
        </div>
        <div class="quick-search">
          <input type="search" id="cmd-search" placeholder="Command search (Ctrl + K)" />
          <span id="api-status" class="status-pill">API: Checking…</span>
        </div>
      </div>

      <section id="overview" class="grid">
        <div class="cards">
          <div class="card">
            <h3>API Status</h3>
            <div class="value" id="api-up">—</div>
            <div class="muted">Health of /admin/analytics.</div>
          </div>
          <div class="card">
            <h3>Server Load</h3>
            <div class="value" id="server-load">N/A</div>
            <div class="muted">Wire to infra metrics.</div>
          </div>
          <div class="card">
            <h3>Error Rate (1h)</h3>
            <div class="value" id="error-rate">N/A</div>
            <div class="muted">Not tracked yet.</div>
          </div>
          <div class="card">
            <h3>DB Response</h3>
            <div class="value" id="db-latency">N/A</div>
            <div class="muted">Hook to DB telemetry.</div>
          </div>
        </div>

        <div class="cards">
          <div class="card">
            <h3>Total Users</h3>
            <div class="value" id="total-users">N/A</div>
            <div class="muted">Add user count when available.</div>
          </div>
          <div class="card">
            <h3>Active (24h)</h3>
            <div class="value" id="active-users">N/A</div>
            <div class="muted">Wire to activity service.</div>
          </div>
          <div class="card">
            <h3>New Signups (7d)</h3>
            <div class="value" id="new-signups">N/A</div>
            <div class="muted">Coming from auth analytics.</div>
          </div>
          <div class="card">
            <h3>Scans Processed</h3>
            <div class="value" id="total-scans">0</div>
            <div class="muted">All surfaces combined.</div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>Quick Actions</h2>
            <div class="tag">2-click rule</div>
          </div>
          <div class="actions">
            <button onclick="quickAction('restart')">Restart Services</button>
            <button onclick="quickAction('maintenance')" class="btn-ghost">Toggle Maintenance</button>
            <button onclick="quickAction('cache')" class="btn-ghost">Flush Cache</button>
            <button onclick="quickAction('experiment')" class="btn-ghost">Toggle Experimental</button>
          </div>
          <div class="actions" style="margin-top: 8px;">
            <button onclick="quickAction('alerts')">Silence Alerts (15m)</button>
            <button onclick="quickAction('sync')">Force Data Sync</button>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>Timeline Feed</h2>
            <div class="badges-row">
              <span class="tag">Scans</span>
              <span class="tag">Feedback</span>
              <span class="tag warn">Warnings</span>
            </div>
          </div>
          <div id="timeline" class="timeline"></div>
        </div>
      </section>

      <section id="intelligence" class="section">
        <div class="section-header">
          <h2>Detection Intelligence</h2>
          <div class="badges-row">
            <span class="tag">Live</span>
            <span class="tag warn">High-Risk</span>
            <span class="tag">False Positives</span>
          </div>
        </div>
        <div class="cards">
          <div class="card">
            <h3>Scans Today</h3>
            <div class="value" id="scans-today">0</div>
            <div class="muted">Last 24h.</div>
          </div>
          <div class="card">
            <h3>High-Risk Flags</h3>
            <div class="value" id="high-risk">0</div>
            <div class="muted">Scam detections.</div>
          </div>
          <div class="card">
            <h3>False Positives</h3>
            <div class="value" id="false-positive">N/A</div>
            <div class="muted">Hook to review queue.</div>
          </div>
          <div class="card">
            <h3>Top Patterns</h3>
            <div class="value" id="top-patterns">Not tracked</div>
            <div class="muted">Add pattern telemetry feed.</div>
          </div>
        </div>
        <div class="chart-grid">
          <div class="chart-card">
            <h3>Risk Trend</h3>
            <canvas id="trendChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Detection Distribution</h3>
            <canvas id="distChart"></canvas>
          </div>
        </div>
      </section>

      <section id="users" class="section">
        <div class="section-header">
          <h2>User Management</h2>
          <div class="badges-row">
            <span class="tag">Search</span>
            <span class="tag warn">Risk Filters</span>
          </div>
        </div>
        <div class="controls-row">
          <input type="search" id="user-search" placeholder="Search users (email, id)" />
          <select id="user-filter">
            <option value="">Filter by risk level</option>
            <option>High</option>
            <option>Medium</option>
            <option>Low</option>
          </select>
          <select id="user-tier">
            <option value="">Subscription tier</option>
            <option>Free</option>
            <option>Premium</option>
          </select>
        </div>
        <table class="table" id="user-table">
          <thead>
            <tr><th>User</th><th>Plan</th><th>Risk Avg</th><th>Last Seen</th><th>Actions</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="5" class="muted">Wire to user service. Use filters above to narrow.</td></tr>
          </tbody>
        </table>
      </section>

      <section id="engine" class="section">
        <div class="section-header">
          <h2>Detection Engine Control</h2>
          <div class="badges-row">
            <span class="tag">Sensitivity</span>
            <span class="tag">Models</span>
            <span class="tag warn">Overrides</span>
          </div>
        </div>
        <div class="controls-row">
          <div>
            <label>Sensitivity</label>
            <input class="range" type="range" min="0" max="100" value="65" id="sensitivity" />
          </div>
          <div>
            <label>Confidence Threshold</label>
            <input class="range" type="range" min="0" max="100" value="60" id="confidence" />
          </div>
          <div>
            <label>AI Model</label>
            <select id="model-select">
              <option>Default v1</option>
              <option>Precision v2</option>
              <option>Recall-Heavy v3</option>
            </select>
          </div>
          <div>
            <label>Pipeline</label>
            <select id="pipeline-select">
              <option>Standard</option>
              <option>High scrutiny</option>
              <option>Latency optimized</option>
            </select>
          </div>
        </div>
        <div class="actions">
            <button onclick="quickAction('override-safe')" class="btn-ghost">Whitelist Domain</button>
            <button onclick="quickAction('override-block')" class="btn-danger">Blacklist Domain</button>
            <button onclick="saveEngineConfig()">Save Engine Config</button>
        </div>
      </section>

      <section id="simulation" class="section">
        <div class="section-header">
          <h2>Rule Simulation</h2>
          <div class="badges-row">
            <span class="tag warn">Preview Only</span>
          </div>
        </div>
        <div class="controls-row">
          <input type="text" id="sim-scenario" placeholder="Scenario name" />
          <button onclick="runSimulation()">Run Simulation</button>
        </div>
        <div class="cards">
          <div class="card">
            <h3>Projected False Positives</h3>
            <div class="value" id="sim-fp">—</div>
            <div class="muted">Increase vs current baseline.</div>
          </div>
          <div class="card">
            <h3>Affected Verdicts</h3>
            <div class="value" id="sim-affected">—</div>
            <div class="muted">Past scans impacted by rule changes.</div>
          </div>
          <div class="card">
            <h3>Notes</h3>
            <div class="muted" id="sim-note">Awaiting simulation.</div>
          </div>
        </div>
      </section>

      <section id="assistant" class="section">
        <div class="section-header">
          <h2>AI Admin Assistant</h2>
          <div class="badges-row">
            <span class="tag">Advisor</span>
            <span class="tag warn">Suggestions</span>
          </div>
        </div>
        <div class="grid-two">
          <div class="card">
            <h3>Anomalies</h3>
            <div class="muted" id="ai-anomalies">Waiting for data…</div>
          </div>
          <div class="card">
            <h3>Recommendations</h3>
            <div class="muted" id="ai-reco">Waiting for data…</div>
          </div>
        </div>
      </section>

      <section id="system-map" class="section">
        <div class="section-header">
          <h2>System Map</h2>
          <div class="badges-row">
            <span class="tag">Topology</span>
            <span class="tag warn">Live</span>
          </div>
        </div>
        <div class="cards">
          <div class="card">
            <h3>Flow</h3>
            <div class="muted">User → API → Detection → Database</div>
            <div class="muted" id="map-status">All nodes nominal.</div>
          </div>
          <div class="card">
            <h3>Bottlenecks</h3>
            <div class="muted" id="map-bottleneck">Not detected.</div>
          </div>
          <div class="card">
            <h3>Error Hotspots</h3>
            <div class="muted" id="map-errors">None reported.</div>
          </div>
        </div>
      </section>

      <section id="false-positive" class="section">
        <div class="section-header">
          <h2>False Positive Resolution</h2>
          <div class="badges-row">
            <span class="tag warn">Review</span>
            <span class="tag">Training Loop</span>
          </div>
        </div>
        <table class="table">
          <thead>
            <tr><th>Case</th><th>Reason</th><th>User</th><th>Actions</th></tr>
          </thead>
          <tbody id="fp-table">
            <tr><td colspan="4" class="muted">No appeals yet. Wire to review queue.</td></tr>
          </tbody>
        </table>
      </section>

      <section id="logs" class="section">
        <div class="section-header">
          <h2>Logs & Debug</h2>
          <div class="badges-row">
            <span class="tag">Live</span>
            <span class="tag warn">Warnings</span>
            <span class="tag">Export</span>
          </div>
        </div>
        <div class="controls-row">
          <select>
            <option>Errors</option>
            <option>Warnings</option>
            <option>Auth</option>
            <option>Detection</option>
          </select>
          <div class="actions" style="gap:6px;">
            <button onclick="exportLogs()">Export CSV</button>
            <button onclick="quickAction('stream')">Start Stream</button>
          </div>
        </div>
        <div class="log-panel" id="log-panel">
          No logs yet. Hook to your log pipeline.
        </div>
      </section>

      <section id="flags" class="section">
        <div class="section-header">
          <h2>Feature Flags & Environment</h2>
          <div class="badges-row">
            <span class="tag">Switchboard</span>
            <span class="tag warn">Beta</span>
          </div>
        </div>
        <div class="cards">
          <div class="card">
            <h3>Feature Flags</h3>
            <div class="badges-row">
              <button onclick="toggleFlag('beta_ui')">Toggle Beta UI</button>
              <button onclick="toggleFlag('ai_mode')">Toggle AI Mode</button>
              <button onclick="toggleFlag('active_blocking')">Toggle Active Blocking</button>
            </div>
          </div>
          <div class="card">
            <h3>Environment</h3>
            <div class="badges-row">
              <span class="tag">Live Mode</span>
              <span class="tag warn">Maintenance</span>
              <span class="tag">Debug</span>
            </div>
          </div>
        </div>
      </section>

      <section id="feedback-intel" class="section">
        <div class="section-header">
          <h2>Feedback Intelligence Dashboard</h2>
          <div class="badges-row">
            <span class="tag">Clustering</span>
            <span class="tag warn">High Frustration</span>
            <span class="tag">Priority Engine</span>
          </div>
        </div>
        <div class="cards">
          <div class="card">
            <h3>Total Feedback</h3>
            <div class="value" id="feedback-total">0</div>
            <div class="muted">All structured submissions.</div>
          </div>
          <div class="card">
            <h3>Avg Frustration</h3>
            <div class="value" id="feedback-frustration">0</div>
            <div class="muted">User-reported intensity.</div>
          </div>
          <div class="card">
            <h3>Spam/Toxic Flags</h3>
            <div class="value" id="feedback-abuse">0</div>
            <div class="muted">Filtered by abuse layer.</div>
          </div>
          <div class="card">
            <h3>AI Suggestions</h3>
            <div class="value" id="feedback-suggestion-count">0</div>
            <div class="muted">Generated daily.</div>
          </div>
        </div>

        <div class="grid-two">
          <div class="card">
            <div class="section-header">
              <h3>Priority Queue (frustration x frequency x risk)</h3>
              <div class="badges-row">
                <button onclick="refreshFeedbackIntel()">Refresh</button>
              </div>
            </div>
            <div id="feedback-priority" class="timeline"></div>
          </div>
          <div class="card">
            <div class="section-header">
              <h3>Clusters</h3>
              <div class="badges-row">
                <span class="tag">Similarity</span>
                <span class="tag warn">Repeats</span>
              </div>
            </div>
            <div id="feedback-clusters" class="timeline"></div>
          </div>
        </div>

        <div class="grid-two">
          <div class="card">
            <h3>Heatmap & Trends</h3>
            <div class="muted">Modes with the most complaints</div>
            <div id="feedback-heatmap"></div>
            <div class="muted" style="margin-top:8px;">Weekly / Monthly</div>
            <div id="feedback-trends" class="badges-row"></div>
          </div>
          <div class="card">
            <h3>AI Suggestions & Auto-responses</h3>
            <ul id="feedback-suggestions" class="replay-list"></ul>
            <div class="muted" id="feedback-replay-hint">
              Feedback replay mode: we capture last scans, verdicts, device, and time-on-page with each submission.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="section-header">
            <h3>Admin Response Layer</h3>
            <div class="badges-row">
              <span class="tag">Respond</span>
              <span class="tag warn">Status</span>
              <span class="tag">Changelog</span>
            </div>
          </div>
          <div class="controls-row">
            <input type="text" id="feedback-active-id" placeholder="Select a feedback item above" />
            <select id="feedback-status">
              <option value="under_review">Under Review</option>
              <option value="in_progress">In Progress</option>
              <option value="fixed">Fixed</option>
              <option value="improved">Improved</option>
              <option value="not_reproducible">Not Reproducible</option>
            </select>
          </div>
          <div class="field">
            <label>Reply to user</label>
            <textarea id="feedback-response" rows="3" placeholder="Short response to user"></textarea>
          </div>
          <div class="field">
            <label>Developer notes / changelog</label>
            <textarea id="feedback-notes" rows="3" placeholder="Root cause, fix path, or internal note"></textarea>
            <input type="text" id="feedback-changelog" placeholder="Optional changelog link" />
          </div>
          <div class="actions" style="margin-top:10px;">
            <button onclick="submitFeedbackResponse()">Push Update</button>
          </div>
          <div id="feedback-response-status" class="status-message"></div>
        </div>
      </section>

      <section id="analytics" class="section">
        <div class="section-header">
          <h2>Analytics & Reporting</h2>
          <div class="badges-row">
            <span class="tag">Exports</span>
            <span class="tag warn">Weekly Reports</span>
          </div>
        </div>
        <div class="chart-grid">
          <div class="chart-card">
            <h3>Scan Volume</h3>
            <canvas id="volumeChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>User Retention (placeholder)</h3>
            <div class="muted">Hook to retention data.</div>
          </div>
          <div class="chart-card">
            <h3>Subscription Churn (placeholder)</h3>
            <div class="muted">Add churn feed.</div>
          </div>
        </div>
      </section>

      <section id="settings" class="section">
        <div class="section-header">
          <h2>Global Settings</h2>
          <div class="badges-row">
            <span class="tag">Keys</span>
            <span class="tag">Integrations</span>
          </div>
        </div>
        <div class="controls-row">
          <input type="text" placeholder="Platform name" />
          <input type="text" placeholder="Detection threshold" />
          <input type="text" placeholder="Payment processor key" />
          <input type="text" placeholder="AI provider key" />
        </div>
        <div class="actions">
          <button onclick="quickAction('save-settings')">Save Settings</button>
          <button class="btn-danger" onclick="quickAction('lockdown')">Lockdown Mode</button>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>
  <div id="cmd-palette" class="command-palette">
    <div class="command-panel">
      <input type="search" id="cmd-input" placeholder="Type a command…" />
      <div id="cmd-list" class="command-list"></div>
    </div>
  </div>

  <script>
    const apiStatusEl = document.getElementById("api-status");
    const timelineEl = document.getElementById("timeline");
    const toastEl = document.getElementById("toast");
    const bannerEl = document.getElementById("incident-banner");
    const cmdPalette = document.getElementById("cmd-palette");
    const cmdInput = document.getElementById("cmd-input");
    const cmdList = document.getElementById("cmd-list");

    let trendChart, distChart, volumeChart;
    let timelineEvents = [];

    const deviceKey = "admin_device_uuid";
    function getDeviceUUID() {
      let id = localStorage.getItem(deviceKey);
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem(deviceKey, id);
      }
      return id;
    }

    function showToast(message) {
      toastEl.textContent = message;
      toastEl.style.display = "block";
      setTimeout(() => (toastEl.style.display = "none"), 2200);
    }

    async function quickAction(action) {
      const destructive = ["restart", "cache", "lockdown", "crisis"];
      let confirmToken = "";
      if (destructive.includes(action)) {
        confirmToken = prompt("Enter admin confirmation token to proceed:") || "";
      }
      try {
        const res = await fetch("/admin/control", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-admin-fingerprint": getDeviceUUID() },
          credentials: "include",
          body: JSON.stringify({ action, confirm_token: confirmToken })
        });
        const data = await res.json();
        if (!res.ok) {
          showToast(data.error || "Control failed");
          return;
        }
        showToast(`Action: ${action} executed`);
        if (data.maintenance !== undefined) {
          setApiStatus(data.maintenance - "Maintenance" : "Up", data.maintenance - "warn" : "ok");
        }
        loadLogs();
      } catch {
        showToast("Network error triggering action");
      }
    }

    function setApiStatus(label, variant = "ok") {
      apiStatusEl.textContent = `API: ${label}`;
      apiStatusEl.style.borderColor = variant === "ok" - "rgba(34,197,94,0.5)" : "rgba(239,68,68,0.6)";
      apiStatusEl.style.background = variant === "ok" - "rgba(34,197,94,0.14)" : "rgba(239,68,68,0.14)";
    }

    async function loadHealth() {
      try {
        const res = await fetch("/admin/health", { credentials: "include", headers: { "x-admin-fingerprint": getDeviceUUID() } });
        const data = await res.json();
        if (!res.ok) {
          setApiStatus("Down", "warn");
          return;
        }

        const health = data.health || {};
        setApiStatus(health.api_status || "Unknown", health.api_status === "up" - "ok" : "warn");
        setText("server-load", health.server_load != null - `${health.server_load}%` : "N/A");
        setText("error-rate", health.error_rate != null - `${health.error_rate}%` : "N/A");
        setText("db-latency", health.db_latency != null - `${health.db_latency} ms` : "N/A");

        if (data.engine) {
          document.getElementById("sensitivity").value = data.engine.sensitivity -- 65;
          document.getElementById("confidence").value = data.engine.confidence -- 60;
          document.getElementById("model-select").value = data.engine.model || "Default v1";
          document.getElementById("pipeline-select").value = data.engine.pipeline || "Standard";
        }

        if (data.crisis) {
          bannerEl.style.display = "block";
        } else {
          bannerEl.style.display = "none";
        }
      } catch {
        setApiStatus("Down", "warn");
      }
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function formatTime(tsMs) {
      return new Date(tsMs).toLocaleString();
    }

    function renderTimeline(events) {
      timelineEl.innerHTML = "";
      if (!events.length) {
        timelineEl.innerHTML = '<div class="muted">No events yet.</div>';
        return;
      }
      events.slice(-30).reverse().forEach((e) => {
        const div = document.createElement("div");
        div.className = "event";
        const dot = document.createElement("div");
        dot.className = "dot";
        if (e.level === "danger") dot.style.background = "var(--danger)";
        if (e.level === "warn") dot.style.background = "var(--warn)";
        div.appendChild(dot);

        const body = document.createElement("div");
        body.className = "body";
        body.innerHTML = `<strong>${e.title}</strong><div class="muted">${e.detail}</div><div class="muted" style="margin-top:4px;">${formatTime(e.time)}</div>`;
        div.appendChild(body);
        timelineEl.appendChild(div);
      });
    }

    function buildCharts(timestamps, safe, scam) {
      const ctxTrend = document.getElementById("trendChart");
      const ctxDist = document.getElementById("distChart");
      const ctxVolume = document.getElementById("volumeChart");

      const labels = timestamps.map((t) => new Date(t * 1000).toLocaleTimeString());
      const values = labels.map(() => 1);

      if (trendChart) trendChart.destroy();
      trendChart = new Chart(ctxTrend, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Scan events",
              data: values,
              borderColor: "#38bdf8",
              borderWidth: 3,
              tension: 0.35,
              fill: false
            }
          ]
        },
        options: {
          plugins: { legend: { labels: { color: "#e5e7eb" } } },
          scales: {
            x: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(55,65,81,0.4)" } },
            y: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(55,65,81,0.3)" } }
          }
        }
      });

      if (distChart) distChart.destroy();
      distChart = new Chart(ctxDist, {
        type: "doughnut",
        data: {
          labels: ["Safe", "Scam"],
          datasets: [{ data: [safe, scam], backgroundColor: ["#22c55e", "#ef4444"] }]
        },
        options: { plugins: { legend: { labels: { color: "#e5e7eb" } } } }
      });

      if (volumeChart) volumeChart.destroy();
      volumeChart = new Chart(ctxVolume, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Volume",
              data: values,
              backgroundColor: "#38bdf8"
            }
          ]
        },
        options: {
          plugins: { legend: { labels: { color: "#e5e7eb" } } },
          scales: {
            x: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(55,65,81,0.2)" } },
            y: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(55,65,81,0.2)" } }
          }
        }
      });
    }

    async function loadAnalytics() {
      try {
        const res = await fetch("/admin/analytics", { headers: { "x-admin-fingerprint": getDeviceUUID() } });
        const data = await res.json();
        if (!res.ok) {
          setApiStatus("Degraded", "warn");
          showToast(data.error || "Failed to load analytics");
          return;
        }

        setApiStatus("Up", "ok");

        const total = data.total_requests || 0;
        const scam = data.scam_detections || 0;
        const safe = data.safe_detections || 0;
        const ocr = data.ocr_uses || 0;
        const timestamps = Array.isArray(data.timestamp_log) - data.timestamp_log : [];
        const now = Date.now() / 1000;
        const scansToday = timestamps.filter((t) => now - t < 86400).length;

        setText("total-scans", total);
        setText("high-risk", scam);
        setText("scans-today", scansToday);
        setText("false-positive", "N/A");
        setText("top-patterns", "Connect pattern feed");

        buildCharts(timestamps, safe, scam);

        const events = timestamps.map((t) => ({
          time: t * 1000,
          title: "Scan event",
          detail: "Scan processed across surfaces.",
          level: "info"
        }));
        timelineEvents = events;
        renderTimeline(timelineEvents);

        document.getElementById("log-panel").textContent =
          "Recent scans: " + scansToday + " today - Safe: " + safe + " - Scam: " + scam + " - OCR: " + ocr;
      } catch (err) {
        setApiStatus("Down", "warn");
        showToast("Network error loading analytics.");
      }
    }

    async function loadFeedback() {
      try {
        const res = await fetch("/admin/feedback", { headers: { "x-admin-fingerprint": getDeviceUUID() } });
        const data = await res.json();
        if (!res.ok) return;

        const events =
          data.map((item) => ({
            time: item.timestamp * 1000,
            title: "User feedback",
            detail: `${item.page || "Unknown page"} - ${item.message}`,
            level: "warn"
          })) || [];

        timelineEvents = timelineEvents.concat(events);
        renderTimeline(timelineEvents);
      } catch {
        // ignore
      }
    }

    let activeFeedbackId = "";

    function setActiveFeedback(id) {
      activeFeedbackId = id;
      const input = document.getElementById("feedback-active-id");
      if (input) input.value = id;
      const statusBox = document.getElementById("feedback-response-status");
      if (statusBox) statusBox.textContent = `Responding to ${id}`;
    }

    function renderFeedbackIntel(data) {
      setText("feedback-total", data.total -- 0);
      setText("feedback-frustration", data.frustration_avg -- 0);
      setText("feedback-abuse", data.abuse_filtered -- 0);
      setText("feedback-suggestion-count", (data.suggestions || []).length);

      const priorityEl = document.getElementById("feedback-priority");
      priorityEl.innerHTML = "";
      const priority = data.high_priority || [];
      if (!priority.length) {
        priorityEl.innerHTML = '<div class="muted">No feedback yet.</div>';
      } else {
        priority.slice(0, 10).forEach((item) => {
          const div = document.createElement("div");
          div.className = "event";
          const tagList = []
            .concat(item.tags-.auto || [])
            .concat(item.tags-.user || [])
            .concat(item.tags-.admin || [])
            .slice(0, 4);
          const changelog = (item.linked_changelog || [])[0];
          const linkHtml = changelog
            - `<div class="muted">Changelog: <a href="${changelog}" target="_blank">${changelog}</a></div>`
            : "";
          const impactHtml =
            item.score_impact_prediction != null
              - `<div class="muted">Impact +${item.score_impact_prediction}</div>`
              : "";
          const replayHtml =
            item.replay && Array.isArray(item.replay.trace)
              - `<div class="muted">Replay: ${item.replay.trace.length} events (${item.context-.mode || "n/a"})</div>`
              : "";
          const abuseHtml =
            item.abuse_flags && item.abuse_flags.length
              - `<div class="muted">Abuse flags: ${item.abuse_flags.join(", ")}</div>`
              : "";
          div.innerHTML = `
            <div class="dot"></div>
            <div class="body">
              <strong>${item.verdict || item.context-.verdict || "Feedback"} - P${Math.round(item.priority || 0)}</strong>
              <div class="muted">Frustration ${item.frustration || 0}/10, Risk ${item.risk_impact || item.context-.risk_score || "-"}</div>
              ${replayHtml}
              <div class="muted">${(item.message || item.combined_text || "").slice(0, 140)}</div>
              ${abuseHtml}
              ${linkHtml}
              ${impactHtml}
              <div class="badges-row" style="margin-top:6px;">${tagList.map((t) => `<span class="tag">${t}</span>`).join("")}</div>
              <button class="btn-ghost" onclick="setActiveFeedback('${item.id}')">Respond</button>
            </div>
          `;
          priorityEl.appendChild(div);
        });
      }

      const clusterEl = document.getElementById("feedback-clusters");
      clusterEl.innerHTML = "";
      const clusters = data.clusters || [];
      if (!clusters.length) {
        clusterEl.innerHTML = '<div class="muted">No clusters yet.</div>';
      } else {
        clusters.slice(0, 8).forEach((c) => {
          const div = document.createElement("div");
          div.className = "event";
          div.innerHTML = `
            <div class="dot" style="background: var(--warn);"></div>
            <div class="body">
              <strong>${c.count}x similar reports</strong>
              <div class="muted">Frustration avg ${c.frustration_avg} - Peak P${c.priority_peak}</div>
              <div class="muted">${(c.sample || "").slice(0, 140)}</div>
              <div class="badges-row" style="margin-top:6px;">${(c.top_tags || []).map((t) => `<span class="tag">${t}</span>`).join("")}</div>
            </div>
          `;
          clusterEl.appendChild(div);
        });
      }

      const heatmapEl = document.getElementById("feedback-heatmap");
      heatmapEl.innerHTML = "";
      const heat = data.heatmap || {};
      const modes = heat.modes || [];
      const tags = heat.tags || [];
      const pages = heat.pages || [];
      const buildList = (items, label) =>
        `<div class="muted" style="margin-top:6px;">${label}: ${items
          .map((i) => `${i.label} (${i.count})`)
          .join(", ")}</div>`;
      heatmapEl.innerHTML =
        buildList(modes, "Modes") + buildList(tags, "Tags") + buildList(pages, "Pages");

      const trendsEl = document.getElementById("feedback-trends");
      trendsEl.innerHTML = `
        <span class="tag">Weekly: ${data.trends-.weekly_count -- 0}</span>
        <span class="tag">Monthly: ${data.trends-.monthly_count -- 0}</span>
      `;

      const suggestionEl = document.getElementById("feedback-suggestions");
      suggestionEl.innerHTML = "";
      (data.suggestions || []).forEach((s) => {
        const li = document.createElement("li");
        li.textContent = s;
        suggestionEl.appendChild(li);
      });
    }

    async function refreshFeedbackIntel() {
      try {
        const res = await fetch("/admin/feedback/intel", {
          headers: { "x-admin-fingerprint": getDeviceUUID() },
          credentials: "include"
        });
        const data = await res.json();
        if (!res.ok) {
          showToast(data.error || "Failed to load feedback intel");
          return;
        }
        renderFeedbackIntel(data);
      } catch (err) {
        showToast("Network error loading feedback intel");
      }
    }

    async function submitFeedbackResponse() {
      const id = (document.getElementById("feedback-active-id").value || "").trim();
      if (!id) {
        document.getElementById("feedback-response-status").textContent = "Select a feedback item first.";
        return;
      }
      const payload = {
        id,
        status: document.getElementById("feedback-status").value,
        response: document.getElementById("feedback-response").value,
        developer_notes: document.getElementById("feedback-notes").value,
        changelog_links: (document.getElementById("feedback-changelog").value || "").trim()
          - [document.getElementById("feedback-changelog").value.trim()]
          : [],
        tags: []
      };
      try {
        const res = await fetch("/admin/feedback/respond", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-admin-fingerprint": getDeviceUUID() },
          credentials: "include",
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) {
          document.getElementById("feedback-response-status").textContent = data.error || "Update failed.";
          return;
        }
        document.getElementById("feedback-response-status").textContent = "Updated.";
        refreshFeedbackIntel();
      } catch {
        document.getElementById("feedback-response-status").textContent = "Network error updating feedback.";
      }
    }

    function exportLogs() {
      const content = document.getElementById("log-panel").textContent || "";
      const blob = new Blob([content], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "admin-logs.txt";
      a.click();
      URL.revokeObjectURL(url);
      showToast("Logs exported.");
    }

    document.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
        e.preventDefault();
        document.getElementById("cmd-search").focus();
        openPalette();
      }
      if (e.key === "Escape" && cmdPalette.style.display === "flex") {
        closePalette();
      }
    });

    async function toggleFlag(name) {
      try {
        const res = await fetch("/admin/flags", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-admin-fingerprint": getDeviceUUID() },
          credentials: "include",
          body: JSON.stringify({ name, value: true }) // backend toggles; value is ignored
        });
        const data = await res.json();
        if (!res.ok) {
          showToast(data.error || "Flag update failed");
          return;
        }
        showToast(`Flag ${name} updated`);
        loadLogs();
      } catch {
        showToast("Network error updating flag");
      }
    }

    async function saveEngineConfig() {
      try {
        const payload = {
          sensitivity: parseInt(document.getElementById("sensitivity").value || "65", 10),
          confidence: parseInt(document.getElementById("confidence").value || "60", 10),
          model: document.getElementById("model-select").value,
          pipeline: document.getElementById("pipeline-select").value
        };
        const res = await fetch("/admin/engine", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-admin-fingerprint": getDeviceUUID() },
          credentials: "include",
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) {
          showToast(data.error || "Failed to save engine config");
          return;
        }
        showToast("Engine configuration saved");
        loadLogs();
      } catch {
        showToast("Network error saving engine config");
      }
    }

    async function runSimulation() {
      const scenario = document.getElementById("sim-scenario").value || "default";
      try {
        const res = await fetch("/admin/simulate", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-admin-fingerprint": getDeviceUUID() },
          credentials: "include",
          body: JSON.stringify({ scenario })
        });
        const data = await res.json();
        if (!res.ok) {
          showToast(data.error || "Simulation failed");
          return;
        }
        setText("sim-fp", data.projected_false_positive_increase -- "—");
        setText("sim-affected", data.affected_verdicts -- "—");
        document.getElementById("sim-note").textContent = data.note || "Simulation complete.";
      } catch {
        showToast("Network error running simulation");
      }
    }

    function populateAssistant() {
      const anomalies = timelineEvents.length > 10 - "Spike detected in scan volume." : "No anomalies.";
      const recommendations = bannerEl.style.display === "block"
        - "Keep crisis mode until metrics stabilize."
        : "Consider running simulation before adjusting sensitivity.";
      document.getElementById("ai-anomalies").textContent = anomalies;
      document.getElementById("ai-reco").textContent = recommendations;
    }

    async function loadAssistant() {
      try {
        const res = await fetch("/admin/assistant", { headers: { "x-admin-fingerprint": getDeviceUUID() } });
        const data = await res.json();
        if (!res.ok || data.available === false) {
          return;
        }
        document.getElementById("ai-anomalies").textContent = data.analysis || "Assistant response unavailable.";
        document.getElementById("ai-reco").textContent = "See assistant analysis above.";
      } catch {
        // ignore
      }
    }

    async function loadFPQueue() {
      try {
        const res = await fetch("/admin/fp", { credentials: "include", headers: { "x-admin-fingerprint": getDeviceUUID() } });
        const data = await res.json();
        if (!res.ok) return;
        const tbody = document.getElementById("fp-table");
        tbody.innerHTML = "";
        if (!data.items || !data.items.length) {
          tbody.innerHTML = '<tr><td colspan="4" class="muted">No appeals yet.</td></tr>';
          return;
        }
        data.items.forEach((item) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.id}</td>
            <td>${item.reason || ""}</td>
            <td>${item.user_id || "N/A"}</td>
            <td>
              <button onclick="resolveFP(${item.id}, 'approved')">Approve</button>
              <button class="btn-ghost" onclick="resolveFP(${item.id}, 'rejected')">Reject</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch {
        // ignore
      }
    }

    async function resolveFP(id, status) {
      try {
        const res = await fetch("/admin/fp/resolve", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-admin-fingerprint": getDeviceUUID() },
          credentials: "include",
          body: JSON.stringify({ id, status })
        });
        const data = await res.json();
        if (!res.ok) {
          showToast(data.error || "Unable to resolve");
          return;
        }
        showToast(`Case ${id} marked ${status}`);
        loadFPQueue();
        loadLogs();
      } catch {
        showToast("Network error updating case");
      }
    }

    const commands = [
      { label: "Enable maintenance mode", action: "maintenance" },
      { label: "Restart detection engine", action: "restart" },
      { label: "Show high-risk users", action: "show-high-risk" },
      { label: "Flush cache", action: "cache" },
      { label: "Lockdown system", action: "lockdown" },
      { label: "Enable crisis mode", action: "crisis" }
    ];

    function openPalette() {
      cmdPalette.style.display = "flex";
      renderCommandList(commands);
      setTimeout(() => cmdInput.focus(), 10);
    }

    function closePalette() {
      cmdPalette.style.display = "none";
      cmdInput.value = "";
    }

    function renderCommandList(list) {
      cmdList.innerHTML = "";
      list.forEach((cmd) => {
        const div = document.createElement("div");
        div.className = "command-item";
        div.textContent = cmd.label;
        div.addEventListener("click", () => {
          closePalette();
          if (cmd.action === "show-high-risk") {
            document.getElementById("intelligence").scrollIntoView({ behavior: "smooth" });
          } else {
            quickAction(cmd.action);
          }
        });
        cmdList.appendChild(div);
      });
    }

    cmdInput-.addEventListener("input", (e) => {
      const q = e.target.value.toLowerCase();
      const filtered = commands.filter((c) => c.label.toLowerCase().includes(q));
      renderCommandList(filtered);
    });

    async function loadLogs() {
      try {
        const res = await fetch("/admin/logs", { credentials: "include", headers: { "x-admin-fingerprint": getDeviceUUID() } });
        const data = await res.json();
        if (!res.ok) return;
        const logs = data.logs || [];
        const logPanel = document.getElementById("log-panel");
        logPanel.textContent = logs
          .slice()
          .reverse()
          .map((l) => {
            const level = (l.level || "INFO").toString().toUpperCase();
            return `[${formatTime(l.timestamp * 1000)}] ${level} - ${l.event}`;
          })
          .join("\n");
      } catch {
        // ignore
      }
    }

    loadAnalytics();
    loadFeedback();
    loadHealth();
    loadLogs();
    loadAssistant();
    loadFPQueue();
    refreshFeedbackIntel();
    setInterval(loadHealth, 30000);
    setInterval(loadAnalytics, 45000);
    setInterval(loadLogs, 45000);
    setInterval(refreshFeedbackIntel, 60000);
  </script>
</body>
</html>
